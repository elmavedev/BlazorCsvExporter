@page "/export-demo"
@rendermode InteractiveServer

@using BlazorCsvExporter.Components
@using BlazorCsvExporter.Models
@using BlazorCsvExporter.Services
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject CsvService CsvService

<PageTitle>BlazorCsvExporter Demo — CSV Export</PageTitle>

<h2>CSV Export Demo</h2>

<div class="card">
    <p>
        This example exports a simple list of employees to CSV format.
    </p>

    <!-- Interactive controls -->
    <div class="demo-controls">
        <div class="demo-controls-row">
            <label>
                <span class="control-label">Delimiter:</span>
                <select @bind="Delimiter">
                    <option value=";">Semicolon (;)</option>
                    <option value=",">Comma (,)</option>
                    <option value="\t">Tab (\t)</option>
                </select>
            </label>

            <label class="checkbox-label">
                <input type="checkbox" @bind="IncludeHeader" />
                Include header row
            </label>
        </div>

        <div class="demo-controls-row">
            <span class="control-label">Columns:</span>
            @foreach (var col in allColumns)
            {
                <label class="column-option">
                    <input type="checkbox"
                           value="@col"
                           checked="@selectedColumns.Contains(col)"
                           @onchange="e => ToggleColumn(col, e)" />
                    @col
                </label>
            }
        </div>
    </div>

    <!-- Export summary -->
    <p class="note small">
        <strong>@employees.Count</strong> record(s) will be exported using
        <code>@GetDelimiterLabel()</code> as delimiter,
        @(IncludeHeader ? "including" : "without") a header row.
        The preview below updates automatically as you change the options.
    </p>

    <!-- Employee table -->
    @if (employees.Any())
    {
        <table class="demo-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Department</th>
                    <th class="text-end">Salary</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in employees)
                {
                    <tr>
                        <td>@e.Name</td>
                        <td>@e.Department</td>
                        <td class="text-end">@e.Salary</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="alert">
            No data available to export.
        </div>
    }

    <!-- Export button and status -->
    <CsvExporter TItem="Employee"
                 Data="@employees"
                 FileName="@fileName"
                 IncludeHeader="@IncludeHeader"
                 Delimiter="@Delimiter"
                 Columns="SelectedColumns"
                 ButtonText="@buttonText"
                 OnCsvGenerated="HandleCsvGenerated" />

    <p class="note small">
        Status: @statusMessage
    </p>
</div>

<!-- CSV preview (auto-updated) -->
@if (!string.IsNullOrEmpty(csvPreview))
{
    <div class="csv-preview">
        <div class="csv-preview-header">
            <span>💾 Generated CSV Preview</span>
            <button type="button"
                    class="csv-copy-btn"
                    @onclick="CopyCsvToClipboard">
                Copy
            </button>
        </div>
        <pre>@csvPreview</pre>
    </div>
}

<!-- Developer info -->
<div class="card dev-note">
    <strong>Developer notes</strong>
    <ul>
        <li>Preview is generated using <code>CsvService.GenerateCsv&lt;T&gt;</code> as you change the options.</li>
        <li>The download button uses the same options to create the final CSV file.</li>
        <li>CSV is generated in-memory and downloaded via a <code>data:</code> URL (no external dependencies).</li>
    </ul>
</div>

@code {
    // Demo data
    private List<Employee> employees = new()
    {
        new() { Name = "John",  Department = "IT",       Salary = 45000 },
        new() { Name = "Anna",  Department = "HR",       Salary = 42000 },
        new() { Name = "Peter", Department = "Finance",  Salary = 50000 }
    };

    // All available columns (property names)
    private readonly string[] allColumns = new[]
    {
        nameof(Employee.Name),
        nameof(Employee.Department),
        nameof(Employee.Salary)
    };

    // Selected columns (internal state)
    private readonly HashSet<string> selectedColumns = new();

    // Backing fields for options
    private string delimiter = ";";
    private bool includeHeader = true;

    private string fileName = "Employees.csv";
    private string buttonText = "Download Employee List";
    private string? csvPreview;
    private string statusMessage = "Preview ready";

    // Properties with setters that update the preview
    private string Delimiter
    {
        get => delimiter;
        set
        {
            if (delimiter != value)
            {
                delimiter = value;
                UpdateCsvPreview();
            }
        }
    }

    private bool IncludeHeader
    {
        get => includeHeader;
        set
        {
            if (includeHeader != value)
            {
                includeHeader = value;
                UpdateCsvPreview();
            }
        }
    }

    protected override void OnInitialized()
    {
        // Select all columns by default
        foreach (var col in allColumns)
        {
            selectedColumns.Add(col);
        }

        // Generate initial preview
        UpdateCsvPreview();
    }

    private IEnumerable<string> SelectedColumns =>
        selectedColumns.Any() ? selectedColumns : Array.Empty<string>();

    private void ToggleColumn(string column, ChangeEventArgs e)
    {
        bool isChecked = e.Value is bool b && b
                         || e.Value is string s && (s == "true" || s == "on");

        if (isChecked)
            selectedColumns.Add(column);
        else
            selectedColumns.Remove(column);

        UpdateCsvPreview();
    }

    private string GetDelimiterLabel()
    {
        return Delimiter switch
        {
            "\t" => "Tab (\\t)",
            "," => ",",
            ";" => ";",
            _ => Delimiter
        };
    }

    private void UpdateCsvPreview()
    {
        if (!employees.Any())
        {
            csvPreview = string.Empty;
            statusMessage = "No data to preview";
            return;
        }

        var options = new CsvOptions
        {
            IncludeHeader = IncludeHeader,
            Delimiter = Delimiter,
            Columns = SelectedColumns
        };

        csvPreview = CsvService.GenerateCsv(employees, options);
        statusMessage = "Preview updated";
    }

    private void HandleCsvGenerated(string csv)
    {
        // Keep this for demo purposes: when the user actually downloads the file
        statusMessage = $"File downloaded at {DateTime.Now:T}";
    }

    private async Task CopyCsvToClipboard()
    {
        if (!string.IsNullOrEmpty(csvPreview))
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", csvPreview);
        }
    }

    public class Employee
    {
        public string Name { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public int Salary { get; set; }
    }
}
